- name: Bootstrap
  hosts: ripper

  vars:
    pb_user: krelinga
    smb_user: ripper
    smb_password: "{{ vault.ripper_smb_password }}"
    makemkv_key: "{{ vault.makemkv_registration }}"
    makemkv_storage_dir: "/home/{{ pb_user }}/makemkv"
    makemkv_config_dir: "{{ makemkv_storage_dir }}/config"
    devices:
      - number: 0
        devnum: 0
      - number: 1
        devnum: 1
      - number: 2
        devnum: 3
      - number: 3
        devnum: 2
      - number: 4
        devnum: 4

  roles:
    - role: geerlingguy.docker
      vars:
        docker_users:
          - "{{ pb_user }}"
      become: true
    - role: geerlingguy.pip
      vars:
        pip_install_packages:
          - name: docker
            state: present
      become: true
    - role: ssh_server

  tasks:
    - name: Create makeMKV directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        recurse: true
        mode: "0755"
      with_items:
        - "{{ makemkv_storage_dir }}"
        - "{{ makemkv_config_dir }}"

    - name: Set up makeMKV containers
      community.docker.docker_container:
        name: "makeMKV-{{ item.number }}"
        image: jlesage/makemkv
        pull: true
        ports:
          - "580{{ item.number }}:5800"
        devices:
          - "/dev/sr{{ item.devnum }}:/dev/sr0"
          - "/dev/sg{{ item.devnum }}:/dev/sg0"
        env:
          DARK_MODE: "1"
          DISPLAY_WIDTH: "1280"
          DISPLAY_HEIGHT: "720"
          MAKEMKV_KEY: "{{ makemkv_key }}"
        restart_policy: "unless-stopped"
        recreate: true
        mounts:
          - type: bind
            target: /config
            read_only: false
            source: "{{ makemkv_config_dir }}"
          - type: bind
            target: /storage
            read_only: true
            source: "{{ makemkv_storage_dir }}"
          - type: volume
            target: /output
            read_only: false
            volume_driver: local
            volume_options:
              type: cifs
              device: "//truenas.i.krel.ing/media/Rip"
              o: "username={{ smb_user }},password={{ smb_password }},file_mode=0666,dir_mode=0777,addr=truenas.i.krel.ing"
      with_items: "{{ devices }}"
