- name: Bootstrap
  become: true
  hosts: ripper

  vars:
      pb_user: krelinga
      makemkv_storage_dir: "/home/{{ pb_user }}/makemkv"
      makemkv_config_dir: "{{ makemkv_storage_dir }}/config"
      makemkv_output_dir: "{{ makemkv_storage_dir }}/output"
      devices:
        - number: 1
          device: "/dev/disk/by-path/platform-1000110000.pcie-pci-0000:01:00.0-ata-6"
          devnum: 2
        - number: 2
          device: "/dev/disk/by-path/platform-1000110000.pcie-pci-0000:01:00.0-ata-2"
          devnum: 0
        - number: 3
          device: "/dev/disk/by-path/platform-1000110000.pcie-pci-0000:01:00.0-ata-4"
          devnum: 1

  pre_tasks:
    # See https://github.com/raspberrypi/linux/issues/6214
    - name: Work-around SATA controller issue
      ansible.builtin.lineinfile:
        dest: /boot/firmware/config.txt
        line: "{{ item }}"
        search_string: "{{ item }}"
        insertafter: EOF
        state: present
      with_items:
        - "dtparam=pcie-32bit-dma-pi5"
        - "dtoverlay=pciex1-compat-pi5,no-mip"
      register: changed_config_txt

    - name: Reboot after config.txt changes
      ansible.builtin.reboot:
      when: changed_config_txt is changed

  roles:
    - role: geerlingguy.docker
      vars:
        docker_users:
          - "{{ pb_user }}"

    - role: geerlingguy.pip
      vars:
        pip_install_packages:
          - name: docker
            state: present


  tasks:
    - name: Create makeMKV directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        recurse: true
        mode: "0755"
      with_items:
        - "{{ makemkv_storage_dir }}"
        - "{{ makemkv_config_dir }}"
        - "{{ makemkv_output_dir }}"

    - name: Create per-device symbolic links
      ansible.builtin.file:
        src: "{{ item.device }}"
        dest: "/dev/dvd{{ item.number }}"
        owner: root
        group: root
        state: link
      with_items: "{{ devices }}"

    - name: Set up makeMKV containers
      community.docker.docker_container:
        name: "makeMKV-{{ item.number }}"
        image: jlesage/makemkv
        ports:
          - "580{{ item.number }}:5800"
        devices:
          - "/dev/sr{{ item.devnum }}:/dev/sr0"
          - "/dev/sg{{ item.devnum }}:/dev/sg0"
        env:
          DARK_MODE: "1"
          DISPLAY_WIDTH: "1280"
          DISPLAY_HEIGHT: "720"
        mounts:
          - type: bind
            target: /config
            read_only: false
            source: "{{ makemkv_config_dir }}"
          - type: bind
            target: /storage
            read_only: true
            source: "{{ makemkv_storage_dir }}"
          - type: bind
            target: /output
            read_only: false
            source: "{{ makemkv_output_dir }}"
      with_items: "{{ devices }}"
