- name: Ensure required caller-provided variables are set
  ansible.builtin.assert:
    that:
      - pve_api_host != ""
      - pve_root_password != ""
      - pve_node != ""
    fail_msg: "Required variables are not set. Please check your configuration."

- name: Configure PVE Repositories
  ansible.builtin.apt_repository:
    repo: "{{ item.repo }}"
    filename: "{{ item.filename }}"
    state: "{{ item.state }}"
    update_cache: false
  loop:
    - repo: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
      filename: "pve-no-subscription"
      state: present
    - repo: "deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise"
      filename: "pve-enterprise"
      state: absent
    - repo: "deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription"
      filename: "ceph-no-subscription"
      state: present
    - repo: "deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise"
      filename: "ceph-enterprise"
      state: absent
      
- name: Update Apt Cache
  ansible.builtin.apt:
    update_cache: yes

- name: Apt Upgrade
  ansible.builtin.apt:
    name: "*"
    state: latest

- name: "Set up VMs"
  ansible.builtin.include_tasks: vm.yaml
  loop: "{{ pve_vms }}"
  loop_control:
    label: "{{ vm.name }}"
    loop_var: vm