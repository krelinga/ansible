- name: Create docker volume for Postgres data
  community.docker.docker_volume:
    name: postgres_data
    state: present
  register: postgres_data

- name: Create docker network for Postgres
  community.docker.docker_network:
    name: postgres_network
    state: present
  register: postgres_network

- name: Create docker container for Postgres
  community.docker.docker_container:
    name: postgres
    image: postgres:latest
    state: started
    restart_policy: unless-stopped
    restart: "{{ 'yes' if postgres_data.changed or postgres_network.changed else 'no' }}"
    pull: always
    ports: 5432:5432
    env:
      POSTGRES_PASSWORD: "{{ vault.postgres_password }}"
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - name: postgres_network

- name: "Create docker container for pgadmin"
  community.docker.docker_container:
    name: pgadmin
    image: dpage/pgadmin4:9
    state: started
    restart_policy: unless-stopped
    restart: "{{ 'yes' if postgres_network.changed else 'no' }}"
    pull: always
    ports:
      - 25008:80
    env:
      PGADMIN_DEFAULT_EMAIL: "{{ vault.my_email }}"
      PGADMIN_DEFAULT_PASSWORD: "{{ vault.pgadmin_password }}"
    networks:
      - name: postgres_network

- name: "Wait for Postgres to be ready"
  community.docker.docker_container_info:
    name: postgres
  register: postgres_info
  until: postgres_info.container.State.Running
  retries: 10
  delay: 6  # seconds

- name: "Ensure video_manager_prod database exists"
  community.postgresql.postgresql_db:
    name: video_manager_prod
    state: present
    login_user: postgres
    login_password: "{{ vault.postgres_password }}"
    login_host: "{{ inventory_hostname }}"
  delegate_to: localhost

- name: "Ensure video_manager_prod user exists"
  community.postgresql.postgresql_user:
    name: video_manager_prod
    password: "{{ vault.video_manager_prod_postgres_password }}"
    state: present
    login_user: postgres
    login_password: "{{ vault.postgres_password }}"
    login_db: video_manager_prod
    login_host: "{{ inventory_hostname }}"
  delegate_to: localhost

- name: "Grant all privileges on video_manager_prod database to video_manager_prod user"
  community.postgresql.postgresql_privs:
    state: present
    privs: ALL
    type: database
    role: video_manager_prod
    login_user: postgres
    login_password: "{{ vault.postgres_password }}"
    login_db: video_manager_prod
    login_host: "{{ inventory_hostname }}"
  delegate_to: localhost
