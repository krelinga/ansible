- name: Check variables
  ansible.builtin.assert:
    that:
      - semaphore_port > 0
      - semaphore_web_root | length > 0
    fail_msg: "The variable 'semaphore_port' must be defined and greater than 0. The variable 'semaphore_web_root' must be defined and not empty."

- name: Create docker volumes for Semaphore
  community.docker.docker_volume:
    name: "{{ item }}"
    state: present
  loop:
    - semaphore_data
    - semaphore_config
    - semaphore_tmp

- name: Ensure semaphore_certs volume exists
  community.docker.docker_volume:
    name: semaphore_certs
    state: present
    driver: local
    driver_options:
      type: cifs
      device: "//truenas.i.krel.ing/certs"
      # mfsymlinks is needed because certbot creates symlinks in this volume
      o: "username=certs_deploy,password={{ vault.certs_deploy_smb_password }},file_mode=0440,dir_mode=0550,ro,vers=3.0,mfsymlinks"

# It's a little annoying that this needs to happen outside of semaphore's capability of reading repos
# on its own, but probably not a big deal.
# per https://docs.semaphoreui.com/administration-guide/installation/#installing-additional-python-packages
- name: Clone ansible repo # noqa latest[git]
  ansible.builtin.git:
    repo: "https://github.com/krelinga/ansible.git"
    dest: "/home/{{ ansible_user }}/ansible"
    force: true
    update: true
  register: semaphore_git_repo

- name: Create docker container for semaphore
  community.docker.docker_container:
    name: semaphore
    image: semaphoreui/semaphore:latest
    state: started
    restart_policy: unless-stopped
    restart: "{{  'yes' if semaphore_git_repo.changed else 'no' }}"
    pull: always
    ports:
      - "0.0.0.0:{{ semaphore_port }}:3000"
    env:
      SEMAPHORE_DB_DIALECT: bolt
      SEMAPHORE_ADMIN: admin
      SEMAPHORE_ADMIN_PASSWORD: "{{ vault.semaphore_admin_password }}"
      SEMAPHORE_ADMIN_NAME: Admin
      SEMAPHORE_ADMIN_EMAIL: "admin@localhost"
      SEMAPHORE_WEB_ROOT: "{{ semaphore_web_root }}"
      SEMAPHORE_GOTIFY_ALERT: "true"
      SEMAPHORE_GOTIFY_URL: "https://gotify.i.krel.ing"
      SEMAPHORE_GOTIFY_TOKEN: "{{ vault.gotify_semaphore_app_token }}"
      SEMAPHORE_SLACK_ALERT: "true"
      SEMAPHORE_SLACK_URL: "{{ vault.grafana_irm_web_socket_for_semaphore }}"
    volumes:
      - semaphore_data:/var/lib/semaphore
      - semaphore_config:/etc/semaphore
      - semaphore_tmp:/tmp/semaphore
      - "/home/{{ ansible_user }}/ansible/requirements.txt:/etc/semaphore/requirements.txt:ro"
      - semaphore_certs:/nas/certs:ro
