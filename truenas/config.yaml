- name: Config
  hosts: truenas

  roles:
    - ssh_server
    - role: tls_cert_push
      tags: ["tls_cert_push"]

  tasks:
    - name: Create groups
      arensb.truenas.group:
        name: "{{ item }}"
        state: present
      loop:
        - "media_readonly"
        - "media_readwrite"
        - "dev_readwrite"
        - "certs_readwrite"
        - "certs_readonly"

    - name: Create users
      arensb.truenas.user:
        name: "{{ item.user }}"
        comment: "{{ item.user }}"
        password: "{{ item.password }}"
        groups: "{{ item.groups | default([]) }}"
        home: "/nonexistent"
        shell: "/usr/local/bin/bash"
        state: present
      loop:
        - user: mbair
          password: "{{ vault.truenas_mbair_password }}"
          groups:
            - media_readwrite
            - dev_readwrite
        - user: ripper
          password: "{{ vault.ripper_smb_password }}"
          groups:
            - media_readwrite
        - user: kodi
          password: "{{ vault.truenas_kodi_password }}"
          groups:
            - media_readonly
        - user: dev
          password: "{{ vault.dev_smb_password }}"
          groups:
            - dev_readwrite
            - certs_readwrite
            - media_readwrite
        - user: certbot
          password: "{{ vault.certbot_smb_password }}"
          groups:
            - certs_readwrite
        - user: certs_deploy
          password: "{{ vault.certs_deploy_smb_password }}"
          groups:
            - certs_readonly
        - user: gamespc
          password: "{{ vault.gamespc_truenas_password }}"
          groups:
            - media_readwrite
        - user: tcserver
          password: "{{ vault.truenas_tcserver_smb_password }}"
          groups:
            - media_readwrite
